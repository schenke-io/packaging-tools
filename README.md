[![Coverage](workbench/resources/md/svg/coverage.svg)]()
[![PHPStan](workbench/resources/md/svg/phpstan.svg)]()
[![Latest Version](https://img.shields.io/packagist/v/schenke-io/packaging-tools?style=plastic)](https://packagist.org/packages/schenke-io/packaging-tools)
[![Test](https://img.shields.io/github/actions/workflow/status/schenke-io/packaging-tools/run-tests.yml?style=plastic&branch=main&label=tests)](https://github.com/schenke-io/packaging-tools/actions?query=workflow%3Arun-tests.yml+branch%3Amain)
[![Total Downloads](https://img.shields.io/packagist/dt/schenke-io/packaging-tools?style=plastic)](https://packagist.org/packages/schenke-io/packaging-tools)

<!--
********************************************************************************
*                                                                              *
*     DO NOT EDIT THIS FILE MANUALLY! IT WILL BE OVERWRITTEN.                  *
*                                                                              *
*     This file was generated by: workbench/MakeMarkdown.php
*     Source files are located in: workbench/resources/md
*
*     If you want to change the content, edit the source files instead.        *
*                                                                              *
********************************************************************************
-->
![cover](workbench/resources/md/cover.png)

# Packaging Tools

[![](.github/werkstatt.png)]()

This package is a collection of tools to simplify the package and project development.

The main elements are:
- **Markdown** Assemble the readme.md file out of small markdown files, class comments and other sources
- **Badge** build the badge custom or from existing files
- **Setup** read the `.packaging-tools.neon` configuration file and modify scripts in `composer.json`

* [Packaging Tools](#packaging-tools)
  * [Installation](#installation)
  * [Concept](#concept)
  * [Configuration](#configuration)
    * [Initialization](#initialization)
    * [Configuration Keys](#configuration-keys)
    * [Detailed Key Purpose](#detailed-key-purpose)
      * [`analyse`](#`analyse`)
      * [`coverage`](#`coverage`)
      * [`infection`](#`infection`)
      * [`markdown`](#`markdown`)
      * [`migrations`](#`migrations`)
      * [`pint`](#`pint`)
      * [`quick`](#`quick`)
      * [`release`](#`release`)
      * [`test`](#`test`)
      * [`customTasks`](#`customtasks`)
    * [Schema Validation](#schema-validation)
  * [Database Migrations](#database-migrations)
    * [Usage](#usage)
    * [Process](#process)
    * [Workbench Support](#workbench-support)
  * [Badges System](#badges-system)
    * [Usage](#usage)
    * [Supported Badge Types (BadgeType Enum)](#supported-badge-types-(badgetype-enum))
    * [Special Badges](#special-badges)
      * [Laravel Forge](#laravel-forge)
    * [Customization](#customization)
  * [Classes](#classes)
    * [Automatic Documentation](#automatic-documentation)
    * [Best Practices for Class Documentation](#best-practices-for-class-documentation)
    * [MarkdownAssembler](#markdownassembler)
      * [How to assemble a markdown](#how-to-assemble-a-markdown)
      * [Public methods of MarkdownAssembler](#public-methods-of-markdownassembler)
    * [MakeBadge](#makebadge)
      * [Public methods of MakeBadge](#public-methods-of-makebadge)
    * [Config](#config)
      * [Public methods of Config](#public-methods-of-config)
    * [Composer](#composer)
      * [Public methods of Composer](#public-methods-of-composer)
    * [TaskRegistry](#taskregistry)
      * [Public methods of TaskRegistry](#public-methods-of-taskregistry)
    * [ProjectContext](#projectcontext)
      * [Public methods of ProjectContext](#public-methods-of-projectcontext)
    * [ClassData](#classdata)

## Installation

Install the package with composer:

```bash
  composer require schenke-io/packaging-tools
```

Add the setup command into `composer.json` under scripts.

```json
{
    
    
    "scripts": {
        "setup": "SchenkeIo\\PackagingTools\\Setup::handle"    
    }
    
}

```



Start the setup:

```bash
  composer setup
```

or initialize the configuration:

```bash
  composer setup config
```

## Concept

This package follows the following concept:
- setup and configuration is controlled by a config file
- manual edits have higher priority than automatics
- when manual edits would be overwritten there is a warning
- the documentation is organised out of components which get assembled at the end 
- important classes and methods are marked and documented
- badges are written from data 
- the build process is controlled by script
- missing files are explained with full path

## Configuration

The package is configured via a `.packaging-tools.neon` file in your project root. This file uses the [NEON](https://ne-on.org/) format, which is similar to YAML but provides stronger schema validation and is ideal for configuration.

### Initialization

To create or sync your configuration file:

```bash
composer setup config
```

### Configuration Keys

The following keys are supported in `.packaging-tools.neon`:

| Key | Type | Purpose | Example |
|---|---|---|---|
| `analyse` | `bool` | Enables PHPStan static analysis | `analyse: true` |
| `coverage` | `bool` | Enables code coverage reporting during tests | `coverage: true` |
| `infection` | `bool` | Enables mutation testing with Infection | `infection: true` |
| `markdown` | `string` | The command to run for Markdown assembly | `markdown: php workbench/MakeMarkdown.php` |
| `migrations` | `string\|array` | Configuration for migration generation | `migrations: mysql:users,posts` |
| `pint` | `bool` | Enables code styling with Laravel Pint | `pint: true` |
| `quick` | `bool\|array` | Group task: `pint`, `test`, `markdown` | `quick: true` |
| `release` | `bool\|array` | Group task for pre-release checks | `release: true` |
| `test` | `string\|false` | Test runner: `pest`, `phpunit` or `false` | `test: pest` |
| `customTasks`| `array` | Mapping of custom task names to commands | `customTasks: { my-task: "ls -la" }` |

### Detailed Key Purpose

#### `analyse`
Runs PHPStan to perform static analysis on your codebase. It automatically detects if you are using standard PHP or Laravel (Larastan).

#### `coverage`
Requires a test runner to be configured. It adds coverage flags to the test command and checks for the existence of `clover.xml`.

#### `infection`
Runs mutation testing to check the quality of your tests. Requires `infection/infection` to be installed.

#### `markdown`
Points to the script that assembles your documentation. Usually `php workbench/MakeMarkdown.php`.

#### `migrations`
Uses `kitloong/laravel-migrations-generator`. Can be a string in the format `connection:table1,table2` or an array of tables for the default connection.

#### `pint`
Uses Laravel Pint to ensure your code follows the project's styling rules.

#### `quick`
A shortcut to run essential checks quickly. By default it runs `pint`, `test` and `markdown`. You can override the list of tasks by providing an array.

#### `release`
A comprehensive check before releasing a new version. It typically runs `pint`, `analyse`, `test`, `coverage`, `infection` and `markdown`.

#### `test`
Selects the testing framework. Supported values are `pest` and `phpunit`. Set to `false` to disable tests.

#### `customTasks`
Allows you to define your own tasks that can be run via `composer setup <task-name>`.

### Schema Validation

All tasks in `packaging-tools` define their own configuration schema using `nette/schema`. This ensures that your configuration is always valid and provides helpful error messages if something is misconfigured.

## Database Migrations

The migrations component helps you keep your package's migrations in sync with your development database. It leverages `kitloong/laravel-migrations-generator` to regenerate migrations from an existing database schema.

### Usage

Run the following command to start the migration regeneration:

```bash
composer migrations
```

### Process

1. **Check for Generator**: The tool verifies if `kitloong/laravel-migrations-generator` is installed.
2. **Connection Selection**: The tool uses the source connection configured in `.packaging-tools.neon` or defaults to your primary database connection.
3. **Cleanup**: Existing migrations in the migrations folder will be deleted to ensure a clean state.
4. **Regeneration**: New migrations are generated from the selected database connection.
5. **Permissions**: Generated migration files are set to read-only (mode 444) to prevent accidental manual edits, encouraging the "database-first" approach for packages.

### Workbench Support

If you are using a workbench for package development, the tool automatically detects and uses `workbench/database/migrations` if it exists.

## Badges System

The badges system allows for automatic generation of SVGs for various project metrics. It supports a wide range of built-in drivers and can be easily extended.

### Usage

Run the following command to generate all detected badges:

```bash
composer setup badges
```

Alternatively, you can call it from PHP:

```php
use SchenkeIo\PackagingTools\Badges\MakeBadge;

MakeBadge::auto();
```

The `auto()` method iterates through all supported badge types and attempts to detect the necessary source files or configurations automatically.

### Supported Badge Types (BadgeType Enum)

The `BadgeType` Enum defines the badges that can be automatically detected and generated:

- **Coverage**: Displays the code coverage percentage. Detected from `clover.xml` (location found via `phpunit.xml`).
- **PhpStan**: Displays the PHPStan analysis level or status. Detected from `phpstan.neon` or `phpstan.neon.dist`.
- **Infection**: Displays the mutation score. Detected from `infection-report.json`.
- **Version**: Displays the latest stable version from Packagist (via shields.io).
- **Downloads**: Displays the total number of downloads from Packagist (via shields.io).
- **Laravel**: Displays the minimum Laravel version requirement parsed from `composer.json`.
- **Tests**: Displays the GitHub Action workflow status (e.g., for "run-tests") (via shields.io).

### Special Badges

#### Laravel Forge

The **Forge** badge is not included in the `BadgeType` enum because it requires specific parameters that cannot be automatically detected. It can be added via the Markdown Assembler:

```php
$assembler->badges()->forge(
    hash: 'your-hash',
    server: 123456,
    site: 654321,
    date: 1, // show date
    label: 1 // show label
);
```

### Customization

You can also define custom badges:

```php
use SchenkeIo\PackagingTools\Badges\MakeBadge;

MakeBadge::define('My Subject', 'Success', '27AE60')
    ->store('resources/md/svg/my-badge.svg');
```

| key        | description                                                                          |
|------------|--------------------------------------------------------------------------------------|
| analyse    | false = disabled, true = enabled (uses phpstan/phpstan-phpunit or larastan/larastan) |
| coverage   | false = disabled, or provide the relative path to the clover.xml file                |
| infection  | false = disabled, true = enabled (requires infection/infection)                      |
| markdown   | false = disabled, true = enabled (assembles Markdown files from resources/md)        |
| migrations | false = disabled, connection:table1,table2 = enabled (with connection and tables)    |
| pint       | false = disabled, true = enabled (uses laravel/pint)                                 |
| quick      | false = disabled, true = enabled (runs tests with --stop-on-failure)                 |
| release    | false = disabled, true = enabled (uses various tools to prepare a release)           |
| test       | false = disabled, true = enabled (runs pest)                                         |

## Classes

The tool can automatically document your package classes by parsing their PHPDoc blocks.

### Automatic Documentation

When using the `MarkdownAssembler`, you can include documentation for all your classes with:

```php
$assembler->classes()->all();
```

This will:
1. Scan your source directory (detected automatically as `src/` or `app/`).
2. Parse the class-level PHPDoc of each class.
3. Generate a formatted list of classes with their descriptions and key methods.

### Best Practices for Class Documentation

To get the most out of this feature, ensure your classes have a comprehensive PHPDoc block:

```php
/**
 * Short description of the class
 *
 * Longer description explaining the purpose of the class
 * and how it should be used within the package.
 */
class MyClass { ... }
```

The assembler looks for at least a few lines of description to ensure quality documentation.

### MarkdownAssembler

Core engine for assembling Markdown documentation.



#### How to assemble a markdown

To assemble a markdown you need these things:
- a directory with well named markdown files
- documentation of classes and methods
- csv files for tables 
- a script
  - which writes badges
  - which read and assemble these files

This script can be a script run by php itself or 
a class file with a static method.




```php
<?php


require "vendor/autoload.php";

use SchenkeIo\PackagingTools\Markdown\MarkdownAssembler;

/*
 * this scripts make the package itself and tests its functionality
 */

try {
    $mda = new MarkdownAssembler(/* subdirectory for markdown include files */);
    $mda->addMarkdown(/* relative to markdown directory */);
    $mda->addTableOfContents();
    // relative to markdown directory
    $mda->addMarkdown("installation.md");
    // makes markdown from a class phpdoc
    $mda->addClassMarkdown(MarkdownAssembler::class);

    // path relative to root directory
    $mda->writeMarkdown("README.md");
} catch (Exception $e) {
    echo "ERROR: " . $e->getMessage() . PHP_EOL;
}




```

#### Public methods of MarkdownAssembler

| method             | summary                                  |
|--------------------|------------------------------------------|
| init               | -                                        |
| autoHeader         | -                                        |
| addMarkdown        | Adds a markdown file.                    |
| addTableOfContents | add a table of content for the full file |
| addText            | adds markdown text                       |
| addContentProvider | -                                        |
| badges             | -                                        |
| classes            | -                                        |
| tables             | -                                        |
| toc                | -                                        |
| image              | -                                        |
| writeMarkdown      | writes all added elements into one file  |

### MakeBadge

Central class for generating and storing SVG badges.

#### Public methods of MakeBadge

| method             | summary                                                      |
|--------------------|--------------------------------------------------------------|
| auto               | Automatically detect and generate all supported badge types. |
| define             | Create a new MakeBadge instance with manual definitions.     |
| fromDriver         | Create a new MakeBadge instance using a driver.              |
| makeCoverageBadge  | Create a coverage badge from a clover.xml file.              |
| makePhpStanBadge   | Create a PHPStan badge from a neon configuration file.       |
| makeInfectionBadge | Create an Infection badge from a JSON report.                |
| info               | Get the informational summary string for the badge.          |
| store              | Generate the SVG and store it in a file.                     |

### Config

Handles the configuration for the packaging tools.

#### Public methods of Config

| method          | summary                                                                  |
|-----------------|--------------------------------------------------------------------------|
| getMarkdownDir  | -                                                                        |
| output          | -                                                                        |
| doConfiguration | Entry point for configuration updates                                    |
| getC2pDeltas    | returns a list of deltas from composer.json to configuration             |
| writeConfig     | writes a default configuration file if it doesn't exist or merges deltas |

### Composer

Handles interactions with composer.json.

#### Public methods of Composer

| method               | summary                                                                                        |
|----------------------|------------------------------------------------------------------------------------------------|
| save                 | persists the modified composer.json back to disk                                               |
| hasPackage           | checks if a package is already present in composer.json                                        |
| packageFound         | checks if a package is already present in composer.json                                        |
| getToolsFromComposer | scans composer.json for known tool packages and returns their configuration states             |
| setCommands          | updates a script entry in composer.json for a given task                                       |
| setPackages          | checks for missing packages required by a task and adds them to a list for installation        |
| setAddPackages       | adds the collected missing packages installation commands to the 'add' script in composer.json |
| getPendingScripts    | returns an array of scripts that are missing or different in composer.json                     |
| getPendingPackages   | returns an array of packages that are missing in composer.json                                 |

### TaskRegistry

Registry for all available setup tasks.

#### Public methods of TaskRegistry

| method       | summary                                                    |
|--------------|------------------------------------------------------------|
| registerTask | -                                                          |
| getAllTasks  | -                                                          |
| getTask      | returns a specific task by name, or null if it's not found |

### ProjectContext

Provides context and metadata for the current project.

#### Public methods of ProjectContext

| method             | summary                                                              |
|--------------------|----------------------------------------------------------------------|
| getEnv             | -                                                                    |
| fullPath           | converts a relative path into a full absolute path from project root |
| isPublicRepository | -                                                                    |
| runProcess         | -                                                                    |

### ClassData

Data transfer object for class metadata.

