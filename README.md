[![Coverage](workbench/resources/md/svg/coverage.svg)](workbench/resources/md/svg/coverage.svg)
[![PHPStan](workbench/resources/md/svg/phpstan.svg)](workbench/resources/md/svg/phpstan.svg)
[![Version](https://img.shields.io/packagist/v/schenke-io/packaging-tools?style=flat)](https://packagist.org/packages/schenke-io/packaging-tools)
[![Downloads](https://img.shields.io/packagist/dt/schenke-io/packaging-tools?style=flat)](https://packagist.org/packages/schenke-io/packaging-tools)
[![Tests](https://github.com/schenke-io/packaging-tools/actions/workflows/run-tests.yml/badge.svg)](https://github.com/schenke-io/packaging-tools/actions/workflows/run-tests.yml)
[![License](https://img.shields.io/github/license/schenke-io/packaging-tools?style=flat)](https://github.com/schenke-io/packaging-tools/blob/main/LICENSE.md)
[![PHP](https://img.shields.io/packagist/php-v/schenke-io/packaging-tools?style=flat)](https://packagist.org/packages/schenke-io/packaging-tools)

<!--
********************************************************************************
*                                                                              *
*     DO NOT EDIT THIS FILE MANUALLY! IT WILL BE OVERWRITTEN.                  *
*                                                                              *
*     This file was generated by: workbench/MakeMarkdown.php
*     Source files are located in: workbench/resources/md
*
*     If you want to change the content, edit the source files instead.        *
*                                                                              *
********************************************************************************
-->
# Packaging Tools

> Tools to simplify publishing github packages

<img src="workbench/resources/md/cover.png" alt="cover" />

This package is a collection of tools to simplify the package and project development.

The main elements are:
- **Markdown** Assemble the readme.md file out of small markdown files, class comments and other sources
- **Badge** build the badge custom or from existing files
- **Setup** read the `.packaging-tools.neon` configuration file and modify scripts in `composer.json`

### Basics

#### GeneratesPackageMigrations
This trait allows your package to easily regenerate its own migrations from the current database schema, ensuring your package's migrations are always in sync with your development environment.

* [Packaging Tools](#packaging-tools)
    * [Basics](#basics)
      * [GeneratesPackageMigrations](#generatespackagemigrations)
  * [Installation](#installation)
  * [Concept](#concept)
  * [Universal Traits](#universal-traits)
  * [Configuration](#configuration)
    * [Initialization](#initialization)
    * [Configuration Keys](#configuration-keys)
    * [Detailed Key Purpose](#detailed-key-purpose)
      * [`analyse`](#analyse)
      * [`coverage`](#coverage)
      * [`infection`](#infection)
      * [`markdown`](#markdown)
      * [`migrations`](#migrations)
      * [`pint`](#pint)
      * [`quick`](#quick)
      * [`release`](#release)
      * [`sql-cache`](#sql-cache)
      * [`test`](#test)
      * [`customTasks`](#customtasks)
    * [Schema Validation](#schema-validation)
  * [Database Migrations](#database-migrations)
    * [Usage](#usage)
    * [Process](#process)
    * [Workbench Support](#workbench-support)
  * [Badges System](#badges-system)
    * [Usage](#usage)
    * [Supported Badge Types (BadgeType Enum)](#supported-badge-types-badgetype-enum)
    * [Special Badges](#special-badges)
      * [Laravel Forge](#laravel-forge)
    * [Customization](#customization)
  * [Classes](#classes)
    * [Automatic Documentation](#automatic-documentation)
    * [Best Practices for Class Documentation](#best-practices-for-class-documentation)
    * [Using @markdown for Extended Documentation](#using-markdown-for-extended-documentation)
      * [Class-level @markdown](#class-level-markdown)
      * [Method-level @markdown](#method-level-markdown)
    * [MarkdownAssembler](#markdownassembler)
      * [How to assemble a markdown](#how-to-assemble-a-markdown)
      * [Public methods of MarkdownAssembler](#public-methods-of-markdownassembler)
    * [MakeBadge](#makebadge)
      * [Public methods of MakeBadge](#public-methods-of-makebadge)
    * [Config](#config)
      * [Public methods of Config](#public-methods-of-config)

## Installation

Install the package with composer:

```bash
  composer require schenke-io/packaging-tools
```

Add the setup command into `composer.json` under scripts.

```json
{
    
    
    "scripts": {
        "setup": "SchenkeIo\\PackagingTools\\Setup::handle"    
    }
    
}

```



Start the setup:

```bash
  composer setup
```

or initialize the configuration:

```bash
  composer setup config
```

## Concept

This package follows the following concept:
- setup and configuration is controlled by a config file
- manual edits have higher priority than automatics
- when manual edits would be overwritten there is a warning
- the documentation is organised out of components which get assembled at the end 
- important classes and methods are marked and documented
- badges are written from data 
- the build process is controlled by script
- missing files are explained with full path

## Universal Traits

Universal Traits provide a bridge between your package and the `packaging-tools` infrastructure. By using these traits, you benefit from:
- **Consistent DX:** Developers familiar with one package using these tools will feel at home with others.
- **Interoperability:** Traits automatically respect the project context (Laravel App vs. Package) and configuration.
- **Encapsulation:** Complex logic like model discovery or SQL loading is hidden behind simple, expressive method calls.

## Configuration

The package is configured via a `.packaging-tools.neon` file in your project root. This file uses the [NEON](https://ne-on.org/) format, which is similar to YAML but provides stronger schema validation and is ideal for configuration.

### Initialization

To create or sync your configuration file:

```bash
composer setup config
```

### Configuration Keys

The following keys are supported in `.packaging-tools.neon`:

| Key | Type | Purpose | Example |
|---|---|---|---|
| `analyse` | `bool` | Enables PHPStan static analysis | `analyse: true` |
| `coverage` | `bool` | Enables code coverage reporting during tests | `coverage: true` |
| `infection` | `bool` | Enables mutation testing with Infection | `infection: true` |
| `markdown` | `string\|null` | The command to run for Markdown assembly | `markdown: php workbench/MakeMarkdown.php` |
| `migrations` | `string\|null` | Configuration for migration generation | `migrations: mysql:users,posts` |
| `pint` | `bool` | Enables code styling with Laravel Pint | `pint: true` |
| `quick` | `array` | Group task: `pint`, `test`, `markdown` | `quick: [pint, test, markdown]` |
| `release` | `array` | Group task for pre-release checks | `release: [pint, analyse, coverage, markdown]` |
| `sql-cache` | `bool|string|null` | Enables SQL caching for tests | `sql-cache: true` |
| `test` | `string` | Test runner: `pest`, `phpunit` or `''` | `test: pest` |
| `customTasks`| `array` | Mapping of custom task names to commands | `customTasks: { my-task: "ls -la" }` |

### Detailed Key Purpose

#### `analyse`
Runs PHPStan to perform static analysis on your codebase. It automatically detects if you are using standard PHP or Laravel (Larastan).

#### `coverage`
Requires a test runner to be configured. It adds coverage flags to the test command and checks for the existence of `clover.xml`.

#### `infection`
Runs mutation testing to check the quality of your tests. Requires `infection/infection` to be installed.

#### `markdown`
Points to the script that assembles your documentation. Usually `php workbench/MakeMarkdown.php`. Use `null` to disable.

#### `migrations`
Uses `kitloong/laravel-migrations-generator`. Can be a string in the format `connection:table1,table2`. Use `null` to disable.

#### `pint`
Uses Laravel Pint to ensure your code follows the project's styling rules.

#### `quick`
A shortcut to run essential checks quickly. By default it runs `pint`, `test` and `markdown`. You can override the list of tasks by providing an array.

#### `release`
A comprehensive check before releasing a new version. It typically runs `pint`, `analyse`, `test`, `coverage`, `infection` and `markdown`.

#### `sql-cache`
Dumps the current SQLite database to an SQL file (default `tests/Data/seeded.sql`). This can be loaded in tests using the `LoadsSeededSql` trait to significantly speed up database preparation. Can be `true` (default path), a `string` (custom path), or `null` (disabled).

> **Note:** To maintain the previous grouped behavior of running migrations and then sql-cache, you can add `@sql-cache` to your custom build commands or scripts.

#### `test`
Selects the testing framework. Supported values are `pest` and `phpunit`. Use an empty string `''` to disable tests.

#### `customTasks`
Allows you to define your own tasks that can be run via `composer setup <task-name>`.

### Schema Validation

All tasks in `packaging-tools` define their own configuration schema using `nette/schema`. This ensures that your configuration is always valid and provides helpful error messages if something is misconfigured.

| key        | description                                                                                      |
|------------|--------------------------------------------------------------------------------------------------|
| analyse    | false = disabled, true = enabled (uses phpstan/phpstan-phpunit or larastan/larastan)             |
| coverage   | false = disabled, true = enabled (adds --coverage to the test runner)                            |
| infection  | false = disabled, true = enabled (requires infection/infection)                                  |
| markdown   | null = disabled, string = enabled (command to assemble Markdown files)                           |
| migrations | null = disabled, connection:table1,table2 = enabled (with connection and tables)                 |
| pint       | false = disabled, true = enabled (uses laravel/pint)                                             |
| quick      | an array of scripts to include in this group: pint, test, markdown                               |
| release    | an array of scripts to include in this group: pint, analyse, test, coverage, infection, markdown |
| sql-cache  | null = disabled, true = default path, 'path/to/file.sql' = custom path                           |
| test       | '' = disabled, 'pest' or 'phpunit' = enabled                                                     |

## Database Migrations

The migrations component helps you keep your package's migrations in sync with your development database. It leverages `kitloong/laravel-migrations-generator` to regenerate migrations from an existing database schema.

### Usage

Run the following command to start the migration regeneration:

```bash
composer migrations
```

### Process

1. **Check for Generator**: The tool verifies if `kitloong/laravel-migrations-generator` is installed.
2. **Connection Selection**: The tool uses the source connection configured in `.packaging-tools.neon` or defaults to your primary database connection.
3. **Cleanup**: Existing migrations in the migrations folder will be deleted to ensure a clean state.
4. **Regeneration**: New migrations are generated from the selected database connection.
5. **Permissions**: Generated migration files are set to read-only (mode 444) to prevent accidental manual edits, encouraging the "database-first" approach for packages.

### Workbench Support

If you are using a workbench for package development, the tool automatically detects and uses `workbench/database/migrations` if it exists.

## Badges System

The badges system allows for automatic generation of SVGs for various project metrics. It supports a wide range of built-in drivers and can be easily extended.

### Usage

Run the following command to generate all detected badges:

```bash
composer setup badges
```

Alternatively, you can call it from PHP:

```php
use SchenkeIo\PackagingTools\Badges\MakeBadge;

MakeBadge::auto();

// generate specific badges with auto-detected paths:
MakeBadge::makeCoverageBadge();
MakeBadge::makePhpStanBadge();
MakeBadge::makeInfectionBadge();
MakeBadge::makePhpVersionBadge();

// or with explicit paths:
MakeBadge::makeCoverageBadge('path/to/clover.xml');
MakeBadge::makePhpStanBadge('path/to/phpstan.neon');
MakeBadge::makeInfectionBadge('path/to/infection-report.json');
```

The `auto()` method iterates through all supported badge types and attempts to detect the necessary source files or configurations automatically.

### Supported Badge Types (BadgeType Enum)

The `BadgeType` Enum defines the badges that can be automatically detected and generated:

- **Coverage**: Displays the code coverage percentage. Detected from `clover.xml` (location found via `phpunit.xml`).
- **PhpStan**: Displays the PHPStan analysis level or status. Detected from `phpstan.neon` or `phpstan.neon.dist`.
- **Infection**: Displays the mutation score. Detected from `infection-report.json`.
- **PHP**: Displays the minimum PHP version requirement parsed from `composer.json`.
- **Version**: Displays the latest stable version from Packagist (via shields.io).
- **Downloads**: Displays the total number of downloads from Packagist (via shields.io).
- **Laravel**: Displays the minimum Laravel version requirement parsed from `composer.json`.
- **Tests**: Displays the GitHub Action workflow status (e.g., for "run-tests") (via shields.io).
- **License**: Displays the project license (via shields.io).

### Special Badges

#### Laravel Forge

The **Forge** badge is not included in the `BadgeType` enum because it requires specific parameters that cannot be automatically detected. It can be added via the Markdown Assembler:

```php
$assembler->badges()->forge(
    hash: 'your-hash',
    server: 123456,
    site: 654321,
    date: 1, // show date
    label: 1 // show label
);
```

### Customization

You can also define custom badges:

```php
use SchenkeIo\PackagingTools\Badges\MakeBadge;

MakeBadge::define('My Subject', 'Success', '27AE60')
    ->store('resources/md/svg/my-badge.svg');
```

## Classes

The tool can automatically document your package classes by parsing their PHPDoc blocks.

### Automatic Documentation

When using the `MarkdownAssembler`, you can include documentation for all your classes with:

```php
$assembler->classes()->all();

// or document a single class:
$assembler->classes()->add(MyClass::class);
```

This will:
1. Scan your source directory (detected automatically as `src/` or `app/`).
2. Parse the class-level PHPDoc of each class.
3. Generate a formatted list of classes with their descriptions and key methods.

### Best Practices for Class Documentation

To get the most out of this feature, ensure your classes have a comprehensive PHPDoc block:

```php
/**
 * Short description of the class
 *
 * Longer description explaining the purpose of the class
 * and how it should be used within the package.
 */
class MyClass { ... }
```

The assembler looks for at least a few lines of description to ensure quality documentation.

### Using @markdown for Extended Documentation

Sometimes, class or method documentation is too extensive for a single PHPDoc block. You can use the `@markdown` tag to include external Markdown files into your class documentation.

#### Class-level @markdown

If you add `@markdown` to your class-level PHPDoc, the tool will look for a Markdown file named after the class's namespace path.

- **Convention:** The path is formed by taking the full namespace, excluding the first two components (usually the vendor and package name), and appending `.md`.
- **Example:** `SchenkeIo\PackagingTools\Markdown\MarkdownAssembler` becomes `Markdown/MarkdownAssembler.md`.
- **Base Directory:** These paths are relative to the markdown source directory passed to the `MarkdownAssembler` constructor.

```php
/**
 * Class Summary
 *
 * @markdown
 */
class MarkdownAssembler { ... }
```

#### Method-level @markdown

Similarly, you can use `@markdown` on individual public methods.

- **Convention:** The tool looks for a `.md` file in a subdirectory named after the class (using the same convention as above).
- **Example:** `MarkdownAssembler::init()` will look for `Markdown/MarkdownAssembler/init.md`.

```php
/**
 * Method Summary
 *
 * @markdown
 */
public function init() { ... }
```

### MarkdownAssembler

Core engine for assembling Markdown documentation.



#### How to assemble a markdown

To assemble a markdown you need these things:
- a directory with well named markdown files
- documentation of classes and methods
- csv files for tables 
- a script
  - which writes badges
  - which read and assemble these files

This script can be a script run by php itself or 
a class file with a static method.




```php
<?php


require "vendor/autoload.php";

use SchenkeIo\PackagingTools\Markdown\MarkdownAssembler;

/*
 * this scripts make the package itself and tests its functionality
 */

try {
    $mda = new MarkdownAssembler('workbench/resources/md');
    $mda->addMarkdown("header.md");
    $mda->addTableOfContents();
    // relative to Markdown directory
    $mda->addMarkdown("installation.md");
    // makes markdown from all classes in src/
    $mda->classes()->all();
    // or from a single class
    $mda->classes()->add(MarkdownAssembler::class);

    // path relative to root directory
    $mda->writeMarkdown("README.md");
} catch (Exception $e) {
    echo "ERROR: " . $e->getMessage() . PHP_EOL;
}




```

#### Public methods of MarkdownAssembler

| method             | summary                                  |
|--------------------|------------------------------------------|
| init               | -                                        |
| skipWrittenBy      | -                                        |
| autoHeader         | -                                        |
| addMarkdown        | Adds a markdown file.                    |
| addTableOfContents | add a table of content for the full file |
| addText            | adds markdown text                       |
| addContentProvider | -                                        |
| badges             | -                                        |
| classes            | -                                        |
| tables             | -                                        |
| toc                | -                                        |
| image              | -                                        |
| writeMarkdown      | writes all added elements into one file  |

### MakeBadge

Central class for generating and storing SVG badges.

#### Public methods of MakeBadge

| method              | summary                                                      |
|---------------------|--------------------------------------------------------------|
| auto                | Automatically detect and generate all supported badge types. |
| define              | Create a new MakeBadge instance with manual definitions.     |
| fromDriver          | Create a new MakeBadge instance using a driver.              |
| makeCoverageBadge   | Create a coverage badge from a clover.xml file.              |
| makePhpStanBadge    | Create a PHPStan badge from a neon configuration file.       |
| makeInfectionBadge  | Create an Infection badge from a JSON report.                |
| makePhpVersionBadge | Create a PHP version badge from composer.json.               |
| info                | Get the informational summary string for the badge.          |
| store               | Generate the SVG and store it in a file.                     |

### Config

Handles the configuration for the packaging tools.

#### Public methods of Config

| method          | summary                                                                  |
|-----------------|--------------------------------------------------------------------------|
| getMarkdownDir  | returns the directory where Markdown source files are located            |
| output          | outputs a message to the console unless silent mode is active            |
| doConfiguration | Entry point for configuration updates                                    |
| getC2pDeltas    | returns a list of deltas from composer.json to configuration             |
| writeConfig     | writes a default configuration file if it doesn't exist or merges deltas |


---

Markdown file generated by [schenke-io/packaging-tools](https://github.com/schenke-io/packaging-tools)
